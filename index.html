<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
        href="https://fonts.googleapis.com/css2?display=swap&family=Inter%3Awght%40400%3B500%3B600%3B700%3B900&family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" />
    <title>FBA Shipment Cost Estimator</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        #resultsPane {
            transition: all 0.3s ease-in-out;
        }
        /* Style for the Yes/No storage buttons */
        .storage-btn {
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            background-color: white;
            color: #374151;
        }
        .storage-btn.active {
            background-color: #1e40af; /* A shade of blue */
            color: white;
            border-color: #1e40af;
        }
    </style>
</head>

<body>
    <div class="relative flex size-full min-h-screen flex-col bg-slate-50 group/design-root overflow-x-hidden"
        style='font-family: Inter, "Noto Sans", sans-serif;'>
        <div id="app-container" class="layout-container flex h-full grow flex-col" style="display:none;">
            <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#e7edf4] px-10 py-3">
                <div class="flex items-center gap-4 text-[#0d141c]">
                    <div class="size-4">
                        <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <g clip-path="url(#clip0_6_330)">
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z"
                                    fill="currentColor"></path>
                            </g>
                            <defs>
                                <clipPath id="clip0_6_330">
                                    <rect width="48" height="48" fill="white"></rect>
                                </clipPath>
                            </defs>
                        </svg>
                    </div>
                    <h2 class="text-[#0d141c] text-lg font-bold leading-tight tracking-[-0.015em]">Shipment Estimator</h2>
                </div>
            </header>

            <div id="calculatorPage" class="px-10 md:px-40 flex flex-1 justify-center py-5">
                <div class="layout-content-container flex flex-col w-full max-w-[960px] flex-1">
                    <h2 class="text-2xl font-bold text-center">Estimate Costs</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8 text-left">
                        <div class="form-group">
                            <label for="cbm" class="block text-sm font-medium text-gray-700">CBM (mÂ³)</label>
                            <input type="number" id="cbm" placeholder="e.g., 53" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div class="form-group">
                            <label for="cartonCount" class="block text-sm font-medium text-gray-700">Carton Count</label>
                            <input type="number" id="cartonCount" placeholder="e.g., 1200" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div class="form-group">
                            <label for="skuCount" class="block text-sm font-medium text-gray-700">SKU Count</label>
                            <input type="number" id="skuCount" placeholder="e.g., 8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div class="form-group">
                            <label for="loadType" class="block text-sm font-medium text-gray-700">Type of Load</label>
                            <select id="loadType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <option value="" disabled selected>Select...</option>
                                <option value="Floor in/Floor out">Floor in/Floor out</option>
                                <option value="Palletized">Palletized</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="location" class="block text-sm font-medium text-gray-700">Location</label>
                            <select id="location" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <option value="" disabled selected>Select...</option>
                                <option value="LOS ANGELES">Los Angeles</option>
                                <option value="SAVANNAH">Savannah</option>
                                <option value="NEW YORK">New York</option>
                            </select>
                        </div>
                        <div class="form-group">
                             <label class="block text-sm font-medium text-gray-700">Storage Required?</label>
                             <div id="storage" class="flex mt-1">
                                <button class="storage-btn active" data-value="Yes">Yes</button>
                                <button class="storage-btn" data-value="No">No</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4 mt-8">
                        <button id="calculateBtn" class="flex-1 flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-[#0d80f2] text-slate-50 text-base font-bold leading-normal tracking-[0.015em]"><span class="truncate">Calculate</span></button>
                        <button id="clearBtn" class="flex-1 flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-slate-600 text-slate-50 text-base font-bold leading-normal tracking-[0.015em]"><span class="truncate">Clear</span></button>
                    </div>

                    <div id="resultsPane" class="mt-10 p-6 bg-blue-50 border border-blue-200 rounded-lg" style="display:none;">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-6 text-center">
                            <div>
                                <h4 class="text-sm font-medium text-slate-500">Container Type</h4>
                                <p id="containerType" class="text-2xl font-bold text-[#0d80f2] mt-1">-</p>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-slate-500">Pallet Count</h4>
                                <p id="palletCount" class="text-2xl font-bold text-[#0d80f2] mt-1">-</p>
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <h4 class="text-sm font-medium text-slate-500">All-in Rate</h4>
                                <p id="allInRate" class="text-2xl font-bold text-green-600 mt-1">$0.00</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 text-left text-xs text-slate-500 bg-slate-100 p-4 rounded-lg">
                         <p><strong>Note 1:</strong> Price includes Drayage, CSR Commission, and Base Service Fee. Carrier costs include a set number of free chassis days; additional chassis fees only apply if standard usage days exceed free days.</p>
                         <p class="mt-2"><strong>Note 2:</strong> Surcharges for cartons and SKUs are applied if counts exceed the included amounts for the container type. Storage fees are added if selected.</p>
                         <p id="palletNote" class="mt-2"><strong>Note 3:</strong> For palletized loads, pallet count and cost ranges are shown. The lower estimate uses a high-density "Operations" pack-out, and the higher estimate uses a standard "Warehouse" pack-out.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- Configuration ---
    const API_KEY = 'AIzaSyAgRYDlwfXHI0AWVOpY8OHHCd7aVgS4Bcc';
    const SPREADSHEET_ID = '1QrO4kP9ikY8Ukr8sxi6egOcPJkbaiGLvx7r4nuDn7cU';
    // ---------------------

    let pricingData = {};
    const elements = {
        appContainer: document.getElementById('app-container'),
        calculatorPage: document.getElementById('calculatorPage'),
        cbm: document.getElementById('cbm'),
        cartonCount: document.getElementById('cartonCount'),
        skuCount: document.getElementById('skuCount'),
        loadType: document.getElementById('loadType'),
        location: document.getElementById('location'),
        storage: document.getElementById('storage'),
        calculateBtn: document.getElementById('calculateBtn'),
        clearBtn: document.getElementById('clearBtn'),
        resultsPane: document.getElementById('resultsPane'),
        containerType: document.getElementById('containerType'),
        palletCount: document.getElementById('palletCount'),
        allInRate: document.getElementById('allInRate'),
    };

    function parseSheetData(values) {
        const data = { locations: {}, carrier: {}, rates: {}, constants: {} };
        const cleanAndParse = (input, isFloat = true) => {
            if (input === undefined || input === null || input === '') return 0;
            const cleanedString = String(input).replace(/[\$,]/g, '');
            const number = isFloat ? parseFloat(cleanedString) : parseInt(cleanedString, 10);
            return isNaN(number) ? 0 : number;
        };
       
        const findHeaderRow = (headerText) => values.findIndex(row => row && row[0] && row[0].trim().toUpperCase() === headerText.toUpperCase());

        const locationHeaders = ["LOS ANGELES PRICING", "SAVANNAH PRICING", "NEW YORK PRICING"];
        locationHeaders.forEach(header => {
            const startRow = findHeaderRow(header);
            if (startRow !== -1) {
                const locationKey = header.replace(" PRICING", "");
                data.locations[locationKey] = {};
                for (let i = startRow + 2; i < startRow + 5; i++) {
                    const row = values[i];
                    if (row && row[0]) {
                        // NEW: Normalize the key to be foolproof (e.g., "40GP/HQ" becomes "40GPHQ")
                        const normalizedKey = row[0].trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
                        data.locations[locationKey][normalizedKey] = {
                            basePrice: cleanAndParse(row[1]),
                            includedCartons: cleanAndParse(row[2], false),
                            includedSkus: cleanAndParse(row[3], false),
                            displayName: row[0].trim() // NEW: Store the original name for display
                        };
                    }
                }
            }
        });

        const carrierStartRow = findHeaderRow("CARRIER PRICING");
        if (carrierStartRow !== -1) {
            for (let i = carrierStartRow + 2; i < carrierStartRow + 5; i++) {
                const row = values[i];
                 if (row && row[0]) {
                    data.carrier[row[0].toUpperCase()] = {
                        drayRate: cleanAndParse(row[2]),
                        chassisCost: cleanAndParse(row[3]),
                        standardChassisDays: cleanAndParse(row[4], false),
                        freeChassisDays: cleanAndParse(row[5], false),
                        csrCommission: cleanAndParse(row[6])
                    };
                }
            }
        }

        values.forEach(row => {
            if (!row) return;
            const key = row[8];
            const value = row[9];
            if(key) {
                const cleanedKey = key.trim();
                if(cleanedKey.toLowerCase().includes('surcharge')) data.rates[cleanedKey] = cleanAndParse(value);
                else if (cleanedKey.toLowerCase().includes('cbm per pallet')) data.constants[cleanedKey] = cleanAndParse(value);
                else if (cleanedKey.toLowerCase().includes('storage')) data.rates[cleanedKey] = cleanAndParse(value);
            }
        });
        return data;
    }

    async function fetchAndParseData() {
        const sheetName = 'Admin_PricingData';
        const range = `${sheetName}!A1:J50`;
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?key=${API_KEY}`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Google Sheets API Error: ${errorData.error.message}`);
            }
            const rawData = await response.json();
            pricingData = parseSheetData(rawData.values);
            elements.appContainer.style.display = 'flex';
        } catch (error) {
            alert(`Fatal Error: Could not load pricing data. ${error.message}. Please check API Key and Sheet settings, then refresh.`);
            console.error(error);
        }
    }

    function calculateEstimate() {
        const cbm = parseFloat(elements.cbm.value);
        const cartonCount = parseInt(elements.cartonCount.value);
        let skuCount = parseInt(elements.skuCount.value);

        if (isNaN(skuCount) || skuCount <= 0) {
            skuCount = 1;
        }
       
        const loadType = elements.loadType.value;
        const location = elements.location.value;
        const storageRequired = elements.storage.querySelector('.active').dataset.value === 'Yes';
       
        if (isNaN(cbm) || cbm <= 0 || isNaN(cartonCount) || cartonCount <= 0) {
            alert('Please enter valid, positive numbers for CBM and Carton Count.');
            return;
        }
        if (!loadType || !location) {
            alert('Please select a Type of Load and a Location.');
            return;
        }

        // UPDATED: Determine the normalized key for lookup
        let containerKey;
        if (cbm <= 32) containerKey = '20GP';
        else if (cbm >= 33 && cbm <= 65) containerKey = '40GPHQ'; // Normalized key
        else containerKey = '45HQ';

        // UPDATED: Use the normalized key to find the pricing object
        const corePricing = pricingData.locations[location]?.[containerKey];
        if (!corePricing) {
            alert(`Error: Could not find pricing for ${location} and container key ${containerKey}. Please check the container names in the Google Sheet.`);
            return;
        }
       
        const carrierInfo = pricingData.carrier[location];
        if (!carrierInfo) {
            alert(`Error: Could not find carrier info for ${location}.`);
            return;
        }

        if (loadType === 'Floor in/Floor out') {
            calculateFloorLoad(cbm, cartonCount, skuCount, storageRequired, corePricing, carrierInfo);
        } else if (loadType === 'Palletized') {
            calculatePalletizedLoad(cbm, cartonCount, skuCount, storageRequired, corePricing, carrierInfo);
        }

        elements.resultsPane.style.display = 'block';
    }

    function calculateFloorLoad(cbm, cartonCount, skuCount, storageRequired, corePricing, carrierInfo) {
        const cartonSurcharge = Math.max(0, cartonCount - corePricing.includedCartons) * (pricingData.rates['Carton Surcharge (Floor in/Pallet out)'] || 0);
        const skuSurcharge = (skuCount > corePricing.includedSkus) ? (pricingData.rates['Sort Surcharge (Floor in/Floor out)'] || 0) : 0;
        const chassisCost = (carrierInfo.standardChassisDays > carrierInfo.freeChassisDays) ? carrierInfo.chassisCost : 0;
        const totalCarrierCost = carrierInfo.drayRate + carrierInfo.csrCommission + chassisCost;
        const storageFee = storageRequired ? cbm * (pricingData.rates['Storage CBM/Day (All)'] || 0) : 0;
        const allInRate = corePricing.basePrice + cartonSurcharge + skuSurcharge + totalCarrierCost + storageFee;
       
        // UPDATED: Use the stored displayName for the output
        elements.containerType.textContent = corePricing.displayName;
        elements.palletCount.textContent = "-";
        elements.allInRate.textContent = allInRate.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
    }
   
    function calculatePalletizedLoad(cbm, cartonCount, skuCount, storageRequired, corePricing, carrierInfo) {
        const opsPallets = Math.ceil(cbm / (pricingData.constants['CBM per Pallet (Operations)'] || 2.20));
        const warehousePallets = Math.ceil(cbm / (pricingData.constants['CBM per Pallet (Warehouse)'] || 1.70));
       
        const cartonSurcharge = Math.max(0, cartonCount - corePricing.includedCartons) * (pricingData.rates['Carton Surcharge (Floor in/Pallet out)'] || 0);
        const skuSurcharge = (skuCount > corePricing.includedSkus) ? (pricingData.rates['Sort Surcharge (Floor in/Pallet out)'] || 0) : 0;
        const chassisCost = (carrierInfo.standardChassisDays > carrierInfo.freeChassisDays) ? carrierInfo.chassisCost : 0;
        const totalCarrierCost = carrierInfo.drayRate + carrierInfo.csrCommission + chassisCost;
        const storageFee = storageRequired ? cbm * (pricingData.rates['Storage CBM/Day (All)'] || 0) : 0;
        const commonCosts = corePricing.basePrice + cartonSurcharge + skuSurcharge + totalCarrierCost + storageFee;
        const outboundPalletRate = pricingData.rates['Outbound Pallet Surcharge (Floor in/Pallet out)'] || 0;
        const outboundOpsSurcharge = opsPallets * outboundPalletRate;
        const outboundWarehouseSurcharge = warehousePallets * outboundPalletRate;
       
        const lowEndRate = commonCosts + outboundOpsSurcharge;
        const highEndRate = commonCosts + outboundWarehouseSurcharge;

        // UPDATED: Use the stored displayName for the output
        elements.containerType.textContent = corePricing.displayName;
        elements.palletCount.textContent = `${opsPallets} - ${warehousePallets}`;
        elements.allInRate.textContent = `${lowEndRate.toLocaleString('en-US', { style: 'currency', currency: 'USD' })} - ${highEndRate.toLocaleString('en-US', { style: 'currency', 'currency': 'USD' })}`;
    }

    function clearForm() {
        elements.cbm.value = '';
        elements.cartonCount.value = '';
        elements.skuCount.value = '';
        elements.loadType.value = '';
        elements.location.value = '';
        elements.resultsPane.style.display = 'none';
        elements.storage.querySelector('[data-value="Yes"]').classList.remove('active');
        elements.storage.querySelector('[data-value="No"]').classList.add('active');
        elements.cbm.focus();
    }

    function initialize() {
        fetchAndParseData();
        elements.storage.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON') {
                elements.storage.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
            }
        });
        elements.calculateBtn.addEventListener('click', calculateEstimate);
        elements.clearBtn.addEventListener('click', clearForm);
    }

    initialize();
</script>
</body>
</html>
